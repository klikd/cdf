import { useState, useEffect, useCallback, useRef } from "react";
import { Link } from "react-router-dom";
import { Button } from "../components/ui/button";
import { Input } from "../components/ui/input";
import { Label } from "../components/ui/label";
import { Textarea } from "../components/ui/textarea";
import { Checkbox } from "../components/ui/checkbox";
import { 
  Select, 
  SelectContent, 
  SelectItem, 
  SelectTrigger, 
  SelectValue 
} from "../components/ui/select";

interface FormData {
  fullName: string;
  email: string;
  relationship: string;
  violationType: string;
  description: string;
  date: string;
  relatedEntity: string;
  anonymous: boolean;
  urgency: string;
  witnesses: string;
  previousReports: string;
  additionalInfo: string;
}

interface FormStep {
  id: number;
  title: string;
  description: string;
  fields: string[];
  progress: number;
}

interface AutoSaveData {
  formData: FormData;
  timestamp: number;
  currentStep: number;
}

interface ValidationErrors {
  email?: string;
  relationship?: string;
  violationType?: string;
  description?: string;
  consent?: string;
}

interface FieldStatus {
  email?: 'valid' | 'invalid' | 'empty';
  relationship?: 'valid' | 'invalid' | 'empty';
  violationType?: 'valid' | 'invalid' | 'empty';
  description?: 'valid' | 'invalid' | 'empty';
  urgency?: 'valid' | 'invalid' | 'empty';
  witnesses?: 'valid' | 'invalid' | 'empty';
}

interface FormAnalytics {
  startTime: number;
  timeSpent: { [key: number]: number };
  fieldInteractions: { [key: string]: number };
  validationErrors: { [key: string]: number };
  completionRate: number;
}

export function WhistleblowingSubmission() {
  // Form Steps Configuration - 4-Step Progressive Disclosure (UX Kit)
  const formSteps: FormStep[] = [
    {
      id: 1,
      title: "معلومات عامة",
      description: "معلومات أساسية عن العلاقة ونوع الإبلاغ",
      fields: ["relationship", "violationType"],
      progress: 25
    },
    {
      id: 2,
      title: "تفاصيل البلاغ",
      description: "ماذا حدث ومتى وأين",
      fields: ["description", "date", "relatedEntity"],
      progress: 50
    },
    {
      id: 3,
      title: "الهوية والخصوصية",
      description: "اختيار الإبلanonymous وتقديم المعلومات",
      fields: ["anonymous", "fullName", "email"],
      progress: 75
    },
    {
      id: 4,
      title: "الإقرار والإرسال",
      description: "الموافقة النهائية وتقديم البلاغ",
      fields: ["file", "consent"],
      progress: 100
    }
  ];

  const [formData, setFormData] = useState<FormData>({
    fullName: "",
    email: "",
    relationship: "",
    violationType: "",
    description: "",
    date: "",
    relatedEntity: "",
    anonymous: false,
    urgency: "",
    witnesses: "",
    previousReports: "",
    additionalInfo: "",
  });

  const [currentStep, setCurrentStep] = useState(1);
  const [consentChecked, setConsentChecked] = useState(false);
  const [file, setFile] = useState<File | null>(null);
  const [errors, setErrors] = useState<ValidationErrors>({});
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [dragActive, setDragActive] = useState(false);
  const [fieldStatus, setFieldStatus] = useState<FieldStatus>({});
  const [isAutoSaving, setIsAutoSaving] = useState(false);
  const [showPreview, setShowPreview] = useState(false);
  const [analytics, setAnalytics] = useState<FormAnalytics>({
    startTime: Date.now(),
    timeSpent: {},
    fieldInteractions: {},
    validationErrors: {},
    completionRate: 0
  });

  const stepStartTime = useRef<number>(Date.now());
  const autoSaveTimeout = useRef<number>();

  // Auto-save functionality
  const autoSave = useCallback(() => {
    const autoSaveData: AutoSaveData = {
      formData,
      timestamp: Date.now(),
      currentStep
    };
    localStorage.setItem('whistleblowingFormAutoSave', JSON.stringify(autoSaveData));
    setIsAutoSaving(false);
  }, [formData, currentStep]);

  // Load auto-saved data
  useEffect(() => {
    const savedData = localStorage.getItem('whistleblowingFormAutoSave');
    if (savedData) {
      try {
        const parsed: AutoSaveData = JSON.parse(savedData);
        setFormData(parsed.formData);
        setCurrentStep(parsed.currentStep);
      } catch (error) {
        console.error('Failed to load auto-saved data:', error);
      }
    }
  }, []);

  // Auto-save on form data change
  useEffect(() => {
    if (autoSaveTimeout.current) {
      clearTimeout(autoSaveTimeout.current);
    }
    setIsAutoSaving(true);
    autoSaveTimeout.current = window.setTimeout(() => {
      autoSave();
    }, 2000);
  }, [formData, autoSave]);

  // Track analytics
  const trackFieldInteraction = (fieldName: string) => {
    setAnalytics(prev => ({
      ...prev,
      fieldInteractions: {
        ...prev.fieldInteractions,
        [fieldName]: (prev.fieldInteractions[fieldName] || 0) + 1
      }
    }));
  };

  // Step navigation
  const nextStep = () => {
    if (currentStep < formSteps.length) {
      // Track time spent on current step
      const timeSpent = Date.now() - stepStartTime.current;
      setAnalytics(prev => ({
        ...prev,
        timeSpent: {
          ...prev.timeSpent,
          [currentStep]: (prev.timeSpent[currentStep] || 0) + timeSpent
        }
      }));
      
      setCurrentStep(currentStep + 1);
      stepStartTime.current = Date.now();
    }
  };

  const prevStep = () => {
    if (currentStep > 1) {
      const timeSpent = Date.now() - stepStartTime.current;
      setAnalytics(prev => ({
        ...prev,
        timeSpent: {
          ...prev.timeSpent,
          [currentStep]: (prev.timeSpent[currentStep] || 0) + timeSpent
        }
      }));
      
      setCurrentStep(currentStep - 1);
      stepStartTime.current = Date.now();
    }
  };

  const goToStep = (step: number) => {
    if (step >= 1 && step <= formSteps.length) {
      const timeSpent = Date.now() - stepStartTime.current;
      setAnalytics(prev => ({
        ...prev,
        timeSpent: {
          ...prev.timeSpent,
          [currentStep]: (prev.timeSpent[currentStep] || 0) + timeSpent
        }
      }));
      
      setCurrentStep(step);
      stepStartTime.current = Date.now();
    }
  };

  // Keyboard shortcuts
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.ctrlKey || e.metaKey) {
        if (e.key === 's') {
          e.preventDefault();
          autoSave();
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (currentStep < formSteps.length) {
            nextStep();
          }
        }
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [currentStep, autoSave]);

  // Real-time field validation
  const validateField = (name: string, value: string) => {
    let status: 'valid' | 'invalid' | 'empty' = 'empty';
    let error = '';

    switch (name) {
      case 'email':
        if (!value) {
          status = 'empty';
        } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
          status = 'invalid';
          error = 'يرجى إدخال بريد إلكتروني صحيح';
        } else {
          status = 'valid';
        }
        break;
      case 'relationship':
        if (!value) {
          status = 'empty';
        } else {
          status = 'valid';
        }
        break;
      case 'violationType':
        if (!value) {
          status = 'empty';
        } else {
          status = 'valid';
        }
        break;
      case 'description':
        if (!value) {
          status = 'empty';
        } else if (value.trim().length < 20) {
          status = 'invalid';
          error = 'يرجى تقديم وصف مفصل للبلاغ (على الأقل 20 حرف)';
        } else {
          status = 'valid';
        }
        break;
    }

    setFieldStatus(prev => ({ ...prev, [name]: status }));
    if (error) {
      setErrors(prev => ({ ...prev, [name]: error }));
    } else {
      setErrors(prev => ({ ...prev, [name]: undefined }));
    }
  };

  const validateForm = (): boolean => {
    const newErrors: ValidationErrors = {};
    
    // Email validation
    if (!formData.email) {
      newErrors.email = "البريد الإلكتروني مطلوب";
    } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email)) {
      newErrors.email = "يرجى إدخال بريد إلكتروني صحيح";
    }
    
    // Required fields
    if (!formData.relationship) {
      newErrors.relationship = "يرجى اختيار العلاقة بالصندوق";
    }
    
    if (!formData.violationType) {
      newErrors.violationType = "يرجى اختيار نوع البلاغ";
    }
    
    if (!formData.description || formData.description.trim().length < 20) {
      newErrors.description = "يرجى تقديم وصف مفصل للبلاغ (على الأقل 20 حرف)";
    }
    
    if (!consentChecked) {
      newErrors.consent = "يرجى الموافقة على الإقرار والموافقة";
    }
    
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!validateForm()) {
      toast.error("يرجى تصحيح الأخطاء قبل الإرسال");
      return;
    }
    
    setIsSubmitting(true);
    
    try {
      // Simulate API call
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      toast.success("تم إرسال البلاغ بنجاح. شكراً لمساهمتك في تعزيز النزاهة.");
      
      // Reset form
      setFormData({
        fullName: "",
        email: "",
        relationship: "",
        violationType: "",
        description: "",
        date: "",
        relatedEntity: "",
        anonymous: false,
      });
      setConsentChecked(false);
      setFile(null);
      setErrors({});
    } catch (error) {
      toast.error("حدث خطأ أثناء إرسال البلاغ. يرجى المحاولة مرة أخرى.");
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleInputChange = (
    e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>
  ) => {
    const { name, value, type } = e.target;
    
    // Track field interaction
    trackFieldInteraction(name);
    
    // Real-time validation for text fields
    if (type === 'text' || type === 'email' || type === 'textarea') {
      validateField(name, value);
    }
    
    if (type === "checkbox") {
      setFormData((prev: FormData) => ({
        ...prev,
        [name]: (e.target as HTMLInputElement).checked,
      }));
    } else {
      setFormData((prev: FormData) => ({ ...prev, [name]: value }));
    }
  };

  const handleDrag = (e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    if (e.type === "dragenter" || e.type === "dragover") {
      setDragActive(true);
    } else if (e.type === "dragleave") {
      setDragActive(false);
    }
  };

  const handleDrop = (e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    setDragActive(false);
    
    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
      setFile(e.dataTransfer.files[0]);
    }
  };

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) {
      setFile(e.target.files[0]);
    }
  };

  return (
    <div className="min-h-screen bg-white">
      <div className="mx-auto max-w-[1200px] px-6 py-12">
        {/* Auto-save indicator */}
        {isAutoSaving && (
          <div className="fixed top-4 left-4 bg-[#0F3A2F] text-white px-3 py-2 rounded-lg text-sm flex items-center gap-2 z-50 animate-slideDown">
            <div className="w-3 h-3 border border-white border-t-transparent rounded-full animate-spin"></div>
            جاري الحفظ التلقائي...
          </div>
        )}

        {/* Page Title */}
        <h1 className="text-4xl font-bold text-[#111827] mb-8">
          الإبلاغ عن المخالفات
        </h1>

        {/* Progress Bar */}
        <div className="mb-12">
          <div className="flex items-center justify-between mb-4">
            {formSteps.map((step, index) => (
              <div key={step.id} className="flex items-center">
                <button
                  onClick={() => goToStep(step.id)}
                  className={`flex items-center justify-center w-12 h-12 rounded-full font-medium transition-all duration-300 ${
                    currentStep >= step.id
                      ? 'bg-[#0F3A2F] text-white'
                      : 'bg-[#E5E7EB] text-[#6B7280] hover:bg-[#D1D5DB]'
                  }`}
                >
                  {step.id}
                </button>
                {index < formSteps.length - 1 && (
                  <div className={`flex-1 h-1 mx-4 transition-all duration-300 ${
                    currentStep > step.id ? 'bg-[#0F3A2F]' : 'bg-[#E5E7EB]'
                  }`}></div>
                )}
              </div>
            ))}
          </div>
          <div className="text-center">
            <h2 className="text-2xl font-semibold text-[#111827] mb-2">
              {formSteps[currentStep - 1]?.title}
            </h2>
            <p className="text-[#6B7280] text-base">
              {formSteps[currentStep - 1]?.description}
            </p>
          </div>
        </div>

        {/* WB_Reportable_Matters - Simple Checklist */}
        <div className="bg-[#F9FAFB] border border-[#E5E7EB] rounded-lg p-6 mb-8">
          <h3 className="text-lg font-semibold text-[#111827] mb-4">ما يمكن الإبلاغ عنه</h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div className="flex items-start gap-3">
              <div className="w-5 h-5 border-2 border-[#0F3A2F] rounded flex items-center justify-center mt-0.5">
                <div className="w-2 h-2 bg-[#0F3A2F] rounded-full"></div>
              </div>
              <div>
                <p className="text-sm font-medium text-[#111827] mb-1">مخالفات مالية</p>
                <p className="text-xs text-[#6B7280]">سوء استخدام الأموال أو الميزانيات</p>
              </div>
            </div>
            
            <div className="flex items-start gap-3">
              <div className="w-5 h-5 border-2 border-[#0F3A2F] rounded flex items-center justify-center mt-0.5">
                <div className="w-2 h-2 bg-[#0F3A2F] rounded-full"></div>
              </div>
              <div>
                <p className="text-sm font-medium text-[#111827] mb-1">مخالفات إدارية</p>
                <p className="text-xs text-[#6B7280]">تجاوز الصلاحيات أو الإجراءات</p>
              </div>
            </div>
            
            <div className="flex items-start gap-3">
              <div className="w-5 h-5 border-2 border-[#0F3A2F] rounded flex items-center justify-center mt-0.5">
                <div className="w-2 h-2 bg-[#0F3A2F] rounded-full"></div>
              </div>
              <div>
                <p className="text-sm font-medium text-[#111827] mb-1">مخالفات أخلاقية</p>
                <p className="text-xs text-[#6B7280]">سوء السلوك أو التحرش</p>
              </div>
            </div>
            
            <div className="flex items-start gap-3">
              <div className="w-5 h-5 border-2 border-[#0F3A2F] rounded flex items-center justify-center mt-0.5">
                <div className="w-2 h-2 bg-[#0F3A2F] rounded-full"></div>
              </div>
              <div>
                <p className="text-sm font-medium text-[#111827] mb-1">مخالفات مشتريات</p>
                <p className="text-xs text-[#6B7280]">تضارب المصالح أو المحاباة</p>
              </div>
            </div>
          </div>
          <p className="mt-4 text-sm text-[#6B7280] italic">
            هذه أمثلة فقط - أي مخالفة نظامية يمكن الإبلاغ عنها
          </p>
        </div>

        {/* WB_Form_Container - Multi-Step Form */}
        <div className="bg-white border border-[#E5E7EB] rounded-lg p-8 mb-8">
          {/* WB_Form_Step_01_General */}
          {currentStep === 1 && (
            <div className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        {/* Relationship */}
        <div>
          <Label htmlFor="relationship" className="text-[#111827] mb-2 text-base font-medium">
            العلاقة بالصندوق *
          </Label>
          <Select value={formData.relationship} onValueChange={(value: string) => {
            setFormData((prev: FormData) => ({ ...prev, relationship: value }));
            validateField('relationship', value);
          }}>
            <SelectTrigger className="h-12 text-base">
              <SelectValue placeholder="اختر علاقتك بالصندوق" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="employee">موظف</SelectItem>
              <SelectItem value="beneficiary">مستفيد</SelectItem>
              <SelectItem value="supplier">مورد</SelectItem>
              <SelectItem value="partner">شريك</SelectItem>
              <SelectItem value="other">أخرى</SelectItem>
            </SelectContent>
          </Select>
          <p className="mt-2 text-sm text-[#6B7280] leading-[1.8]">
            اختر الخيار الأقرب، ولا يشترط الدقة القانونية.
          </p>
          {errors.relationship && (
            <div className="mt-2 flex items-center gap-2 text-red-600">
              <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
              </svg>
              <span className="text-sm font-medium">{errors.relationship}</span>
            </div>
          )}
        </div>

        {/* Violation Type */}
        <div>
          <Label htmlFor="violationType" className="text-[#111827] mb-2 text-base font-medium">
            نوع البلاغ *
          </Label>
          <Select value={formData.violationType} onValueChange={(value: string) => {
            setFormData((prev: FormData) => ({ ...prev, violationType: value }));
            validateField('violationType', value);
          }}>
            <SelectTrigger className="h-12 text-base">
              <SelectValue placeholder="اختر نوع البلاغ" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="financial">مخالفات مالية</SelectItem>
              <SelectItem value="administrative">مخالفات إدارية</SelectItem>
              <SelectItem value="ethical">مخالفات أخلاقية</SelectItem>
              <SelectItem value="procurement">مخالفات مشتريات</SelectItem>
              <SelectItem value="hr">مخالفات موارد بشرية</SelectItem>
              <SelectItem value="other">أخرى</SelectItem>
            </SelectContent>
          </Select>
          <p className="mt-2 text-sm text-[#6B7280] leading-[1.8]">
            اختر النوع الأقرب لوصف المخالفة
          </p>
          {errors.violationType && (
            <div className="mt-2 flex items-center gap-2 text-red-600">
              <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
              </svg>
              <span className="text-sm font-medium">{errors.violationType}</span>
            </div>
          )}
        </div>
      </div>
    </div>
  )}

          {/* WB_Form_Step_02_Details */}
          {currentStep === 2 && (
            <div className="space-y-6">
              {/* Description */}
              <div>
        <Label htmlFor="description" className="text-[#111827] mb-2 text-base font-medium">
          وصف البلاغ *
        </Label>
        <Textarea
          id="description"
          name="description"
          value={formData.description}
          onChange={handleInputChange}
          required
          rows={6}
          placeholder="صف ما لاحظته بوضوح وموضوعية، دون افتراضات أو استنتاجات."
          className="h-32 text-base border-[#E5E7EB] focus:border-[#0F3A2F] focus:ring-[#0F3A2F]/20"
        />
        <p className="mt-2 text-sm text-[#6B7280] leading-[1.8]">
          صف ما لاحظته بوضوح وموضوعية، دون افتراضات أو استنتاجات.
        </p>
        {errors.description && (
          <div className="mt-2 flex items-center gap-2 text-red-600">
            <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
            </svg>
            <span className="text-sm font-medium">{errors.description}</span>
          </div>
        )}
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        {/* Date */}
        <div>
          <Label htmlFor="date" className="text-[#111827] mb-2 text-base font-medium">
            تاريخ الواقعة
          </Label>
          <Input
            type="date"
            id="date"
            name="date"
            value={formData.date}
            onChange={handleInputChange}
            className="h-12 text-base border-[#E5E7EB] focus:border-[#0F3A2F] focus:ring-[#0F3A2F]/20"
          />
          <p className="mt-2 text-sm text-[#6B7280] leading-[1.8]">
            التاريخ التقريبي للواقعة (اختياري)
          </p>
        </div>

        {/* Related Entity */}
        <div>
          <Label htmlFor="relatedEntity" className="text-[#111827] mb-2 text-base font-medium">
            أين حدث ذلك؟
          </Label>
          <Input
            type="text"
            id="relatedEntity"
            name="relatedEntity"
            value={formData.relatedEntity}
            onChange={handleInputChange}
            placeholder="القسم أو المكان أو الجهة المعنية"
            className="h-12 text-base border-[#E5E7EB] focus:border-[#0F3A2F] focus:ring-[#0F3A2F]/20"
          />
          <p className="mt-2 text-sm text-[#6B7280] leading-[1.8]">
            ذكر المكان أو الجهة المعنية (اختياري)
          </p>
        </div>
      </div>
      </div>
    </div>
  )}

          {/* WB_Form_Step_03_Privacy */}
          {currentStep === 3 && (
            <div className="space-y-6">
              {/* Anonymity Toggle */}
              <div>
                <div className="flex items-start gap-3">
          <Checkbox
            id="anonymous"
            name="anonymous"
            checked={formData.anonymous}
            onCheckedChange={(checked: boolean) => {
              setFormData((prev: FormData) => ({ ...prev, anonymous: checked }));
            }}
          />
          <div className="space-y-1">
            <Label htmlFor="anonymous" className="text-[#111827] text-base font-medium cursor-pointer">
              ☐ الإبلاغ دون الإفصاح عن الهوية
            </Label>
            <p className="text-sm text-[#6B7280] leading-[1.8]">
              عند التفعيل: إخفاء الاسم والبريد
            </p>
          </div>
        </div>
        
        {/* Anonymity Assurance Card */}
        {formData.anonymous && (
          <div className="mt-4 bg-[#F0FDF4] border border-[#0F3A2F] rounded-lg p-4">
            <p className="text-sm text-[#0F3A2F] leading-[1.8]">
              لن يتم جمع أو تخزين أي بيانات تعريفية، وسيتم التعامل مع البلاغ بسرية تامة وفق الأنظمة المعمول بها.
            </p>
          </div>
        )}
      </div>

      {/* Identity Fields (shown when not anonymous) */}
      {!formData.anonymous && (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          {/* Full Name */}
          <div>
            <Label htmlFor="fullName" className="text-[#111827] mb-2 text-base font-medium">
              الاسم الكامل
            </Label>
            <Input
              type="text"
              id="fullName"
              name="fullName"
              value={formData.fullName}
              onChange={handleInputChange}
              placeholder="الاسم الثلاثي"
              className="h-12 text-base border-[#E5E7EB] focus:border-[#0F3A2F] focus:ring-[#0F3A2F]/20"
            />
            <p className="mt-2 text-sm text-[#6B7280] leading-[1.8]">
              سيتم التعامل مع معلوماتك بسرية تامة
            </p>
          </div>

          {/* Email */}
          <div>
            <Label htmlFor="email" className="text-[#111827] mb-2 text-base font-medium">
              البريد الإلكتروني
            </Label>
            <Input
              type="email"
              id="email"
              name="email"
              value={formData.email}
              onChange={handleInputChange}
              placeholder="example@email.com"
              className="h-12 text-base border-[#E5E7EB] focus:border-[#0F3A2F] focus:ring-[#0F3A2F]/20"
            />
            <p className="mt-2 text-sm text-[#6B7280] leading-[1.8]">
              للتواصل حول البلاغ إذا لزم الأمر
            </p>
          </div>
        </div>
      )}
    </div>
  )}

  {/* WB_Form_Step_04_Consent */}
  {currentStep === 4 && (
    <div className="space-y-6">
      {/* File Upload */}
      <div>
        <Label htmlFor="file" className="text-[#111827] mb-2 text-base font-medium">
          مستندات داعمة (اختياري)
        </Label>
        <div
          className={`relative border-2 border-dashed rounded-lg p-6 sm:p-8 text-center transition-all duration-300 cursor-pointer ${
            dragActive 
              ? 'border-[#0F3A2F] bg-[#F0FDF4]' 
              : 'border-[#D1D5DB] hover:border-[#6B7280] bg-white'
          }`}
          onDragEnter={handleDrag}
          onDragLeave={handleDrag}
          onDragOver={handleDrag}
          onDrop={handleDrop}
          onClick={() => document.getElementById('file-step4')?.click()}
        >
          <input
            type="file"
            id="file-step4"
            onChange={handleFileChange}
            multiple
            accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
            className="hidden"
            title="اختر ملفات لدعم بلاغك"
          />
          <svg 
            className={`w-12 h-12 mx-auto mb-4 transition-colors ${
              dragActive ? 'text-[#0F3A2F]' : 'text-[#6B7280]'
            }`} 
            fill="none" 
            stroke="currentColor" 
            viewBox="0 0 24 24"
          >
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
          </svg>
          <p className="text-lg font-medium text-[#111827] mb-2">
            {dragActive ? 'أفلت الملفات هنا' : 'اسحب الملفات هنا أو انقر للاختيار'}
          </p>
          <p className="text-sm text-[#6B7280] mb-4">
            PDF, DOC, DOCX, JPG, JPEG, PNG (الحد الأقصى: 10MB)
          </p>
          <Button 
            type="button" 
            variant="outline" 
            className="mx-auto"
            onClick={(e: React.MouseEvent) => {
              e.stopPropagation();
              document.getElementById('file-step4')?.click();
            }}
          >
            اختيار الملفات
          </Button>
        </div>
        
        {file && (
          <div className="mt-4 flex items-center gap-3 p-4 bg-[#F9FAFB] border border-[#E5E7EB] rounded-lg">
            <svg className="w-8 h-8 text-[#6B7280]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <div className="flex-1">
              <p className="text-sm font-medium text-[#111827]">{file.name}</p>
              <p className="text-xs text-[#6B7280]">{(file.size / 1024 / 1024).toFixed(2)} MB</p>
            </div>
            <button
              type="button"
              onClick={() => setFile(null)}
              className="text-red-500 hover:text-red-700 transition-colors p-1"
              aria-label="إزالة الملف"
            >
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        )}
        <p className="mt-4 text-sm text-[#6B7280] leading-[1.8]">
          (اختياري – لا ترفق بيانات شخصية غير ضرورية)
        </p>
      </div>

      {/* WB_Legal_Consent */}
      <div className="bg-[#FFFBEB] border border-[#FDE68A] rounded-lg p-6">
        <div className="flex items-start gap-3">
          <Checkbox
            id="consent"
            checked={consentChecked}
            onCheckedChange={(checked: boolean) => {
              setConsentChecked(checked);
              if (errors.consent) {
                setErrors((prev: ValidationErrors) => ({ ...prev, consent: undefined }));
              }
            }}
            required
          />
          <div className="space-y-2">
            <Label htmlFor="consent" className="text-[#92400E] leading-[1.8] text-base font-medium cursor-pointer">
              إقرار وموافقة *
            </Label>
            <div className="text-sm text-[#92400E] leading-[1.8] space-y-2">
              <p>
                أقرّ بأن المعلومات المقدمة صحيحة حسب علمي، وأنني أقدّم البلاغ بحسن نية، وأوافق على معالجة البلاغ وفق الأنظمة ذات العلاقة وسياسة الإبلاغ عن المخالفات المعتمدة لدى الصندوق.
              </p>
              <p>
                <Link to="/policy" className="text-[#0F3A2F] hover:underline font-medium">
                  سياسة الإبلاغ عن المخالفات
                </Link>
              </p>
              <p className="text-xs text-[#6B7280]">
                لا يمكن إرسال البلاغ دون هذه الموافقة.
              </p>
            </div>
          </div>
        </div>
        
        {errors.consent && (
          <div className="mt-4 flex items-center gap-2 text-red-600">
            <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
            </svg>
            <span className="text-sm font-medium">{errors.consent}</span>
          </div>
        )}
      </div>
    </div>
  )}  

  {/* WB_Form_Progress - Step Navigation */}
  <div className="flex flex-col sm:flex-row items-center justify-between gap-4 mt-8 pt-6 border-t border-[#E5E7EB]">
    <div className="flex gap-4">
      {currentStep > 1 && (
        <Button
          type="button"
          variant="outline"
          onClick={prevStep}
          className="min-h-[44px] text-base font-medium"
        >
          <div className="flex items-center gap-2">
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7 7" />
            </svg>
            <span>السابق</span>
          </div>
        </Button>
      )}
      
      {currentStep < formSteps.length && (
        <Button
          type="button"
          onClick={nextStep}
          className="min-h-[44px] text-base font-medium bg-[#0F3A2F] hover:bg-[#0A2E23]"
        >
          <div className="flex items-center gap-2">
            <span>التالي</span>
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
            </svg>
          </div>
        </Button>
      )}
      
      {currentStep === formSteps.length && (
        <Button
          type="submit"
          disabled={isSubmitting || !consentChecked}
          onClick={handleSubmit}
          className="min-h-[44px] text-base font-medium bg-[#0F3A2F] hover:bg-[#0A2E23] disabled:bg-[#9CA3AF] disabled:cursor-not-allowed"
        >
          {isSubmitting ? (
            <div className="flex items-center gap-3">
              <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
              <span>جاري الإرسال...</span>
            </div>
          ) : (
            <div className="flex items-center gap-2">
              <span>إرسال البلاغ</span>
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18" />
              </svg>
            </div>
          )}
        </Button>
      )}
    </div>
  )}

        {/* WB_Confidentiality_Assurance */}
        <div className="bg-[#F0FDF4] border border-[#0F3A2F] rounded-lg p-6 mb-8">
          <div className="flex items-start gap-4">
            <svg className="w-8 h-8 text-[#0F3A2F] flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
            </svg>
            <div>
              <h2 className="text-xl font-semibold text-[#111827] mb-4">
                خصوصيتك وحمايتك
              </h2>
              <div className="space-y-3 text-sm text-[#0F3A2F] leading-[1.8]">
                <p>
                  <strong>السرية:</strong> يتم التعامل مع جميع بلاغاتك بسرية تامة، ولا يتم الكشف عن هويتك إلا في الحدود التي ينص عليها النظام.
                </p>
                <p>
                  <strong>الحماية:</strong> يوفر النظام حماية كاملة للمبلغين بحسن نية من أي إجراءات انتقامية.
                </p>
                <p>
                  <strong>الأمان:</strong> يتم تخزين جميع المعلومات بشكل آمن باستخدام أحدث تقنيات التشفير.
                </p>
              </div>
            </div>
          </div>
        </div>

        {/* WB_Legal_Disclaimer */}
        <div className="bg-[#F9FAFB] border border-[#E5E7EB] rounded-lg p-6 mb-8">
          <p className="text-sm text-[#6B7280] leading-[1.8] text-center">
            تقديم البلاغ لا يُنشئ التزامًا باتخاذ إجراء محدد أو خلال مدة زمنية معينة.
          </p>
        </div>

        {/* WB_Policy_Reference */}
        <div className="text-center mb-8">
          <p className="text-sm text-[#6B7280] leading-[1.8]">
            بتقديم هذا البلاغ، فإنك توافق على{" "}
            <Link to="/policy" className="text-[#0F3A2F] hover:underline font-medium">
              سياسة الإبلاغ عن المخالفات
            </Link>
            {" "}المعتمدة لدى الصندوق الثقافي.
          </p>
        </div>

        {/* WB_Policy_Reference */}
        <div className="text-center mb-8">
          <p className="text-sm text-[#6B7280] leading-[1.8]">
            بتقديم هذا البلاغ، فإنك توافق على{" "}
            <Link to="/policy" className="text-[#0F3A2F] hover:underline font-medium">
              سياسة الإبلاغ عن المخالفات
            </Link>
            {" "}المعتمدة لدى الصندوق الثقافي.
          </p>
        </div>

        {/* Remove old legal warnings section - replaced with UX Kit components */}
        </div>
      </div>
    </form>
      </div>
    </div>
  );
}
